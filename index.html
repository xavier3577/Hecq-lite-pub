<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NoteShield ‚Äî Mode Messenger P2P (proto)</title>
<style>
  :root{
    --bg:#0c111b; --card:#131a27; --accent1:#5dd6ff; --accent2:#8a5dff; --ok:#1fbf75; --warn:#ffb020; --text:#e5ecff; --muted:#98a2b3;
  }
  *{box-sizing:border-box} body{margin:0;background:radial-gradient(1200px 600px at 50% -10%, #182235 0%, #0c111b 60%) fixed;color:var(--text);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto}
  h1{font-weight:800;text-align:center;margin:20px 12px 12px;text-shadow:0 0 24px #2fd0ff66,0 0 6px #2fd0ff66}
  .container{max-width:980px;margin:0 auto;padding:16px}
  .grid{display:grid;gap:16px}
  @media(min-width:880px){.grid-2{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,#141b2a,#0f1522);border:1px solid #1b2440;border-radius:14px;box-shadow:0 10px 30px #0008;padding:16px}
  label{display:block;font-weight:600;margin:6px 0 6px}
  input[type=password],input[type=text],textarea{width:100%;border:1px solid #223058;background:#0d1422;color:var(--text);border-radius:12px;padding:12px 14px;outline:none}
  textarea{min-height:120px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:0;border-radius:12px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;font-weight:700;padding:10px 16px;cursor:pointer;box-shadow:0 6px 20px #0008}
  .btn.sec{background:#1a2740}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid #243356;background:#0e1625;color:var(--muted);font-size:13px}
  .pill.ok{color:#caffe3;border-color:#234f3a;background:#10261a}
  .pill.warn{color:#ffe7bf;border-color:#4d3c13;background:#1c160a}
  .status{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin:8px 0 16px}
  .chat{height:280px;overflow:auto;border:1px solid #223058;border-radius:12px;background:#0b1322;padding:10px}
  .msg{max-width:75%;padding:10px 12px;margin:8px 0;border-radius:12px;box-shadow:0 6px 18px #0006}
  .me{background:#13315a;margin-left:auto}
  .peer{background:#1e2436}
  .small{font-size:12px;color:var(--muted)}
  .sep{height:1px;background:linear-gradient(90deg,transparent,#2a3d66,transparent);margin:12px 0}
</style>
</head>
<body>
  <h1>NoteShield ‚Äî Mode Messenger P2P (prototype)</h1>

  <div class="container grid">
    <div class="status">
      <span id="netBadge" class="pill ok">En ligne</span>
      <span id="webrtcBadge" class="pill">WebRTC : inactif</span>
      <span id="cryptoBadge" class="pill warn">Chiffrement : pr√™t (PBKDF2)</span>
    </div>

    <div class="card">
      <label for="pwd">Mot de passe (partag√© hors bande)</label>
      <div class="row">
        <input id="pwd" type="password" placeholder="Mot de passe robuste (12+ caract√®res)" style="flex:1" />
        <button class="btn sec" id="togglePwd">üëÅÔ∏è</button>
      </div>
      <div class="small">La cl√© de chiffrement est d√©riv√©e de ce mot de passe (AES-GCM 256 bits). Change-la r√©guli√®rement.</div>
      <div class="sep"></div>

      <div class="grid grid-2">
        <div>
          <label>1) Cr√©er l‚Äôoffre (initiateur)</label>
          <div class="row">
            <button class="btn" id="btnCreateOffer">Cr√©er l‚Äôoffre</button>
            <button class="btn sec" id="btnCopyOffer">Copier</button>
          </div>
          <textarea id="offer" placeholder="L‚Äôoffre SDP appara√Ætra ici"></textarea>
        </div>
        <div>
          <label>2) Coller la r√©ponse (de ton contact)</label>
          <div class="row">
            <button class="btn" id="btnApplyAnswer">Appliquer la r√©ponse</button>
            <button class="btn sec" id="btnClearSig">Effacer</button>
          </div>
          <textarea id="answer" placeholder="Colle ici la r√©ponse SDP re√ßue"></textarea>
        </div>
      </div>

      <div class="sep"></div>

      <div class="grid grid-2">
        <div>
          <label>Alternative : tu es le r√©pondeur</label>
          <div class="row">
            <button class="btn" id="btnAcceptOffer">Accepter l‚Äôoffre re√ßue</button>
            <button class="btn sec" id="btnCopyAnswer">Copier la r√©ponse</button>
          </div>
          <textarea id="incomingOffer" placeholder="Colle ici l‚Äôoffre SDP re√ßue"></textarea>
          <textarea id="generatedAnswer" placeholder="Ta r√©ponse SDP appara√Ætra ici"></textarea>
        </div>
        <div>
          <label>√âtat de la connexion</label>
          <div id="state" class="small">En attente‚Ä¶</div>
          <div class="small">Astuce : l‚Äô√©change d‚Äôoffre/r√©ponse peut aussi se faire en QR dans une prochaine version.</div>
        </div>
      </div>
    </div>

    <div class="card">
      <label>Conversation chiffr√©e</label>
      <div id="chat" class="chat"></div>
      <div class="row" style="margin-top:8px">
        <input id="msg" type="text" placeholder="√âcrire un message‚Ä¶" style="flex:1" />
        <button class="btn" id="send">Envoyer</button>
      </div>
      <div class="small">Les messages voyagent dans un canal de donn√©es WebRTC, **chiffr√©s** avec AES-GCM via la cl√© d√©riv√©e du mot de passe.</div>
    </div>
  </div>

<script>
/* ==== Utilitaires UI ==== */
const $ = sel => document.querySelector(sel);
const chat = $('#chat');
function addMsg(text, who='peer'){
  const b = document.createElement('div');
  b.className = `msg ${who==='me'?'me':'peer'}`;
  b.textContent = text;
  chat.appendChild(b);
  chat.scrollTop = chat.scrollHeight;
}
function setBadge(el, text, cls){
  el.textContent = text;
  el.className = 'pill ' + (cls||'');
}
setBadge($('#netBadge'), navigator.onLine?'En ligne':'Hors ligne', navigator.onLine?'ok':'warn');
window.addEventListener('online', ()=>setBadge($('#netBadge'),'En ligne','ok'));
window.addEventListener('offline',()=>setBadge($('#netBadge'),'Hors ligne','warn'));

/* ==== D√©rivation cl√© (PBKDF2 pour proto) ==== */
let cryptoKey = null;
async function deriveKey(password){
  const enc = new TextEncoder();
  const salt = enc.encode('NoteShield-P2P-v1'); // constant salt (proto). Pour +fort: salt partag√©/rotatif.
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return crypto.subtle.deriveKey(
    {name:'PBKDF2', hash:'SHA-256', salt, iterations:100000},
    baseKey,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
}
async function ensureKey(){
  const pwd = $('#pwd').value || '';
  if(!pwd || pwd.length<4){ throw new Error('Mot de passe vide'); }
  cryptoKey = await deriveKey(pwd);
  setBadge($('#cryptoBadge'),'Chiffrement : actif (cl√© pr√™te)','ok');
}
$('#togglePwd').addEventListener('click',()=>{
  const p=$('#pwd'); p.type = p.type==='password' ? 'text' : 'password';
});

/* ==== WebRTC & canal de donn√©es ==== */
let pc, dc;

function createPeer(){
  const cfg = {iceServers:[{urls:['stun:stun.l.google.com:19302']}]};
  pc = new RTCPeerConnection(cfg);
  pc.oniceconnectionstatechange = updateState;
  pc.onconnectionstatechange = updateState;
  pc.onicecandidate = e=>{
    if(e.candidate) return; // attendre fin de la collecte pour une SDP ¬´ compl√®te ¬ª
    // rien : on lit pc.localDescription ci-dessous au moment voulu
  };
  pc.ondatachannel = (ev)=>{
    dc = ev.channel;
    bindDataChannel();
  };
  setBadge($('#webrtcBadge'),'WebRTC : pr√™t','');
}
function updateState(){
  const s = `ICE: ${pc.iceConnectionState} ‚Äî Connexion: ${pc.connectionState}`;
  $('#state').textContent = s;
  if(pc.connectionState==='connected'){
    setBadge($('#webrtcBadge'),'WebRTC : connect√©','ok');
  }
}

/* Cr√©er Offre (initiateur) */
$('#btnCreateOffer').addEventListener('click', async ()=>{
  try{
    await ensureKey();
    createPeer();
    dc = pc.createDataChannel('ns-chat');
    bindDataChannel();
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    $('#offer').value = JSON.stringify(pc.localDescription);
  }catch(err){ alert(err.message||err); }
});
$('#btnCopyOffer').addEventListener('click', async ()=>{
  await navigator.clipboard.writeText($('#offer').value||'');
});

/* Appliquer R√©ponse (initiateur) */
$('#btnApplyAnswer').addEventListener('click', async ()=>{
  const ans = $('#answer').value.trim();
  if(!ans) return alert('Colle la r√©ponse SDP');
  await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(ans)));
});

/* R√©pondeur : accepter une offre re√ßue */
$('#btnAcceptOffer').addEventListener('click', async ()=>{
  try{
    await ensureKey();
    createPeer();
    const inc = $('#incomingOffer').value.trim();
    if(!inc) return alert('Colle une offre SDP valide');
    await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(inc)));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    $('#generatedAnswer').value = JSON.stringify(pc.localDescription);
  }catch(err){ alert(err.message||err); }
});
$('#btnCopyAnswer').addEventListener('click', async ()=>{
  await navigator.clipboard.writeText($('#generatedAnswer').value||'');
});

$('#btnClearSig').addEventListener('click', ()=>{
  $('#offer').value=''; $('#answer').value=''; $('#incomingOffer').value=''; $('#generatedAnswer').value='';
});

/* Canal de donn√©es : chiffrement/d√©chiffrement */
function bindDataChannel(){
  dc.onopen = ()=>addMsg('üí° Canal chiffr√© ouvert (tu peux √©crire).','peer');
  dc.onmessage = async (ev)=>{
    try{
      const obj = JSON.parse(ev.data);
      const {iv, ct} = obj;
      const ivU8 = Uint8Array.from(atob(iv), c=>c.charCodeAt(0));
      const ctU8 = Uint8Array.from(atob(ct), c=>c.charCodeAt(0));
      const plain = await crypto.subtle.decrypt({name:'AES-GCM', iv:ivU8}, cryptoKey, ctU8);
      const text = new TextDecoder().decode(plain);
      addMsg(text,'peer');
    }catch(e){
      addMsg('‚ö†Ô∏è Message re√ßu, impossible de d√©chiffrer (cl√©/mot de passe diff√©rent ?)','peer');
    }
  };
  dc.onclose = ()=>addMsg('üìµ Canal ferm√©','peer');
}

/* Envoi d‚Äôun message */
$('#send').addEventListener('click', async ()=>{
  const text = $('#msg').value.trim();
  if(!text) return;
  if(!dc || dc.readyState!=='open') return alert('Canal non connect√©');

  try{
    await ensureKey();
    const iv = crypto.getRandomValues(new Uint8Array(12));
    const enc = await crypto.subtle.encrypt({name:'AES-GCM', iv}, cryptoKey, new TextEncoder().encode(text));
    const ivB64 = btoa(String.fromCharCode(...iv));
    const ctB64 = btoa(String.fromCharCode(...new Uint8Array(enc)));
    dc.send(JSON.stringify({iv:ivB64, ct:ctB64}));
    addMsg(text,'me');
    $('#msg').value = '';
  }catch(err){ alert(err.message||err); }
});

/* Init */
createPeer();
</script>
</body>
</html>

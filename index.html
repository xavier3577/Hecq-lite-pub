<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>NoteShield ‚Äî Argon2id + AES-GCM</title>
<meta name="theme-color" content="#0d1117">

<!-- Libs CDN -->
<!-- Argon2 (bundled = WASM embarqu√© via CDN) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/argon2-browser/1.18.0/argon2-bundled.min.js" integrity="sha512-g5X1V4rQt1c2s1M3nq0c8mFUyHk0n3LQag3lr1Ue7zE9Q1x0mXocQ5m8Ck02uI8M0x9+0m3t9YqXwW5X3rC8rQ==" crossorigin="anonymous"></script>
<!-- QR code (g√©n√©ration) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" integrity="sha512-TdC0H9UqkI0rV3iQp0rHqf7k2m9s1PZ2nX9k3sm0n1dQkQ9dVqk3qfE5I5L0qf2r1oQ2i6wq1x5c4tQ8x7i4A==" crossorigin="anonymous"></script>
<!-- QR code (scan cam√©ra) -->
<script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>

<style>
  :root{
    --bg:#0d1117;--card:#121826;--card-2:#141c2b;--text:#c9d1d9;
    --muted:#8b949e;--ok:#1f6feb;--warn:#d29922;--bad:#f85149;--good:#2ea043;
    --accent1:#4f46e5;--accent2:#22d3ee;--accent3:#7c3aed;
    --glow:0 0 24px rgba(34,211,238,.25);
    --border:1px solid #1f2937; --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  a{color:#58a6ff;text-decoration:none}
  .wrap{max-width:880px;margin:40px auto;padding:0 18px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:14px}
  .logo{
    width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#0b1220,#0f1b2e 60%,#10233b);
    box-shadow:inset 0 0 0 1px #1e2a3f,0 0 24px rgba(34,211,238,.12);
    display:grid;place-items:center;
  }
  /* Logo SVG (bouclier NS) */
  .logo svg{width:30px;height:30px;filter:drop-shadow(0 0 6px rgba(34,211,238,.45))}
  h1{font-size:28px;line-height:1.2;margin:0}
  .subtitle{color:var(--muted);margin-top:4px;font-size:14px}
  .badges{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .badge{
    padding:6px 10px;border-radius:999px;background:#0f1524;border:var(--border);color:#bcd;
    font-size:13px;display:inline-flex;align-items:center;gap:8px
  }
  .badge.ok{background:#0f1f15;color:#bfe7c8;border-color:#1e3b2a}
  .badge.warn{background:#231b0e;color:#f3d38c;border-color:#3a2b16}

  .card{background:var(--card);border:var(--border);border-radius:var(--radius);padding:18px;margin-top:18px;box-shadow:var(--glow)}
  .card h2{font-size:18px;margin:0 0 14px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .row>*{flex:1 1 240px}
  input,textarea,select{
    width:100%;background:var(--card-2);border:1px solid #22304a;border-radius:12px;color:var(--text);
    padding:14px 15px;outline:none;transition:.15s;
  }
  input::placeholder,textarea::placeholder{color:#70809b}
  input:focus,textarea:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.15)}
  textarea{min-height:140px;resize:vertical}
  .btn{
    display:inline-flex;align-items:center;justify-content:center;gap:10px;
    padding:12px 18px;border-radius:12px;border:1px solid #243454;
    background:linear-gradient(135deg,var(--accent1),var(--accent2));
    color:#fff;font-weight:600;cursor:pointer;box-shadow:0 10px 22px rgba(79,70,229,.25);
    transition:transform .05s ease,filter .2s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.gray{background:#1b2437;color:#d6deea;border-color:#2a3b5e}
  .btn.red{background:#b91c1c;border-color:#7f1d1d}
  .btn.outline{background:transparent;border:1px dashed #2a3b5e}
  .eye{min-width:56px}
  .meter{height:10px;border-radius:999px;background:#151c2b;border:1px solid #22304a;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e);transition:width .2s ease}
  .hint{color:var(--muted);font-size:13px;margin-top:8px}

  .stack{display:flex;gap:10px;flex-wrap:wrap}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:780px){.grid2{grid-template-columns:1fr}}

  .qr-wrap{display:grid;grid-template-columns:220px 1fr;gap:14px;align-items:start}
  @media (max-width:700px){.qr-wrap{grid-template-columns:1fr}}

  .toast{
    position:fixed;left:50%;bottom:24px;transform:translateX(-50%);
    background:#122138;border:1px solid #244368;color:#cfe8ff;padding:10px 14px;border-radius:10px;
    opacity:0;pointer-events:none;transition:.25s
  }
  .toast.show{opacity:1;pointer-events:auto}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo" aria-hidden="true">
        <!-- Bouclier "NS" (logo NoteShield) -->
        <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
              <stop offset="0" stop-color="#22d3ee"/>
              <stop offset="1" stop-color="#4f46e5"/>
            </linearGradient>
          </defs>
          <path d="M32 6l18 6v12c0 12.5-7.4 23.8-18 28-10.6-4.2-18-15.5-18-28V12l18-6z" fill="url(#g)" stroke="#6ee7ff" stroke-width="1.5"/>
          <path d="M20 40V22h6l8 10V22h6v18h-6l-8-10v10z" fill="#0d1117"/>
        </svg>
      </div>
      <div>
        <h1>NoteShield ‚Äî Argon2id + AES-GCM</h1>
        <div class="badges">
          <span id="net-badge" class="badge">‚Ä¶</span>
          <span id="kdf-badge" class="badge warn">KDF : ‚Ä¶</span>
        </div>
        <div class="subtitle">Chiffrement local. Rien n‚Äôest envoy√© c√¥t√© serveur.</div>
      </div>
    </header>

    <!-- Mot de passe -->
    <section class="card">
      <h2>Mot de passe</h2>
      <div class="row">
        <input id="pwd" type="password" placeholder="Mot de passe robuste (12+ caract√®res)">
        <button id="togglePwd" class="btn gray eye" title="Afficher/Masquer">üëÅ</button>
        <button id="genPwd" class="btn">G√©n√©rer</button>
      </div>
      <div class="meter" style="margin-top:10px"><div id="meterBar" class="bar"></div></div>
      <div id="meterHint" class="hint">Force : 0%</div>
    </section>

    <!-- Chiffrement -->
    <section class="card">
      <h2>Texte en clair</h2>
      <textarea id="plain" placeholder="√âcris ton message ici"></textarea>
      <div class="actions">
        <button id="encryptBtn" class="btn">Chiffrer</button>
        <button id="clearPlain" class="btn gray">Effacer</button>
      </div>
    </section>

    <!-- R√©sultat -->
    <section class="card">
      <h2>R√©sultat (paquet chiffr√© JSON Base64)</h2>
      <textarea id="cipher" class="mono" placeholder="Le paquet chiffr√© appara√Ætra ici"></textarea>
      <div class="actions">
        <button id="copyBtn" class="btn gray">Copier</button>
        <button id="qrBtn" class="btn outline">G√©n√©rer QR</button>
      </div>
      <div class="qr-wrap" style="margin-top:10px">
        <div id="qrcode" style="width:220px;height:220px;"></div>
        <div>
          <div class="small muted">Pour lire un QR : ouvre l‚Äôappareil photo, ou utilise le scanner ci-dessous.</div>
          <div id="reader" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <!-- D√©chiffrement -->
    <section class="card">
      <h2>D√©chiffrer</h2>
      <div class="grid2">
        <textarea id="cipherIn" class="mono" placeholder="Colle ici un paquet JSON chiffr√© (de NoteShield)"></textarea>
        <textarea id="plainOut" placeholder="Le texte d√©chiffr√© appara√Ætra ici" readonly></textarea>
      </div>
      <div class="actions">
        <button id="decryptBtn" class="btn">D√©chiffrer</button>
      </div>
      <div id="decHint" class="hint"></div>
    </section>

    <!-- Mode conversation (local) -->
    <section class="card">
      <h2>Mode conversation (local/offline)</h2>
      <div class="grid2">
        <textarea id="convMe" placeholder="Ton message (clair)"></textarea>
        <textarea id="convOther" class="mono" placeholder="Message chiffr√© re√ßu (colle le JSON ici)"></textarea>
      </div>
      <div class="actions">
        <button id="convSend" class="btn">Chiffrer ‚Üí</button>
        <button id="convRead" class="btn gray">‚Üê D√©chiffrer</button>
      </div>
    </section>

    <p class="hint small">Astuce : Apr√®s chiffrement, le paquet est copi√© automatiquement dans le presse-papiers.</p>
  </div>

  <div id="toast" class="toast">Copi√© !</div>

<script>
/* ========= Helpers base64 / bytes ========= */
const enc = new TextEncoder(), dec = new TextDecoder();
const toB64 = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
const fromB64 = b64 => Uint8Array.from(atob(b64), c => c.charCodeAt(0));
const randBytes = n => crypto.getRandomValues(new Uint8Array(n));

/* ========= UI refs ========= */
const pwd = document.getElementById('pwd');
const togglePwd = document.getElementById('togglePwd');
const genPwd = document.getElementById('genPwd');
const meterBar = document.getElementById('meterBar');
const meterHint = document.getElementById('meterHint');
const netBadge = document.getElementById('net-badge');
const kdfBadge = document.getElementById('kdf-badge');

const plain = document.getElementById('plain');
const encryptBtn = document.getElementById('encryptBtn');
const clearPlain = document.getElementById('clearPlain');

const cipher = document.getElementById('cipher');
const copyBtn = document.getElementById('copyBtn');
const qrBtn = document.getElementById('qrBtn');
const qrcodeBox = document.getElementById('qrcode');

const cipherIn = document.getElementById('cipherIn');
const decryptBtn = document.getElementById('decryptBtn');
const plainOut = document.getElementById('plainOut');
const decHint = document.getElementById('decHint');

const convMe = document.getElementById('convMe');
const convOther = document.getElementById('convOther');
const convSend = document.getElementById('convSend');
const convRead = document.getElementById('convRead');

const toast = document.getElementById('toast');

/* ========= R√©seau / badges ========= */
function updateNet(){
  const online = navigator.onLine;
  netBadge.className = 'badge ' + (online ? 'ok' : 'warn');
  netBadge.textContent = online ? 'En ligne' : 'Hors ligne';
}
window.addEventListener('online',updateNet);
window.addEventListener('offline',updateNet);
updateNet();

/* ========= D√©tection KDF ========= */
let useArgon = false;
(async () => {
  try{
    // simple test pour voir si argon2 est dispo
    if (window.argon2 && argon2.hash) {
      useArgon = true;
      kdfBadge.className = 'badge ok';
      kdfBadge.textContent = 'KDF : Argon2id';
    } else {
      throw new Error('argon2 indisponible');
    }
  }catch(e){
    useArgon = false;
    kdfBadge.className = 'badge warn';
    kdfBadge.textContent = 'KDF : Repli PBKDF2';
  }
})();

/* ========= Force du mot de passe (barre simple) ========= */
function estimateStrength(p){
  if(!p) return 0;
  let score = 0;
  const len = p.length;
  const sets = [
    /[a-z]/.test(p), /[A-Z]/.test(p),
    /[0-9]/.test(p), /[^a-zA-Z0-9]/.test(p)
  ].filter(Boolean).length;
  score += Math.min(40, len*3);   // longueur
  score += sets*15;               // diversit√©
  score = Math.min(100, score);
  return score;
}
function renderStrength(){
  const s = estimateStrength(pwd.value);
  meterBar.style.width = s+'%';
  meterHint.textContent = 'Force : '+s+'%';
}
pwd.addEventListener('input', renderStrength);

/* ========= G√©n√©rateur 21 caract√®res ========= */
function genPassword(){
  const alphabet = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{},.?:|~';
  const bytes = randBytes(21);
  let out = '';
  for(const b of bytes){ out += alphabet[b % alphabet.length]; }
  pwd.value = out;
  renderStrength();
}
genPwd.addEventListener('click', genPassword);

/* ========= Afficher/Masquer ========= */
togglePwd.addEventListener('click',()=>{
  pwd.type = (pwd.type==='password') ? 'text' : 'password';
});

/* ========= D√©rivation de cl√© ========= */
async function deriveKeyArgon(password, salt){
  const params = { time:3, mem: 65536, par:1, hashLen:32, type: argon2.ArgonType.Argon2id };
  const res = await argon2.hash({ pass: password, salt, ...params });
  const keyRaw = res.hash; // Uint8Array
  const key = await crypto.subtle.importKey('raw', keyRaw, {name:'AES-GCM'}, false, ['encrypt','decrypt']);
  return { key, params: { time:3, mem:65536, par:1 } };
}
async function deriveKeyPBKDF2(password, salt){
  const iter = 150000; // r√©pli robuste
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey(
    {name:'PBKDF2', salt, iterations:iter, hash:'SHA-256'},
    baseKey,
    {name:'AES-GCM', length:256},
    false,
    ['encrypt','decrypt']
  );
  return { key, params: { iter } };
}

/* ========= Chiffrement ========= */
async function encrypt(){
  const message = plain.value.trim();
  const password = pwd.value;
  if(!message){ alert('√âcris un message.'); return; }
  if(!password || password.length<8){ alert('Choisis un mot de passe (8+).'); return; }

  const salt = randBytes(16);
  const iv = randBytes(12);

  // KDF
  let key, kdf, kdfParams;
  try{
    if(useArgon){
      const res = await deriveKeyArgon(password, salt);
      key = res.key; kdf = 'argon2id'; kdfParams = res.params;
    }else{
      const res = await deriveKeyPBKDF2(password, salt);
      key = res.key; kdf = 'pbkdf2-sha256'; kdfParams = res.params;
    }
  }catch(err){
    // repli dur si argon √©choue
    const res = await deriveKeyPBKDF2(password, salt);
    key = res.key; kdf = 'pbkdf2-sha256'; kdfParams = res.params;
    useArgon = false;
    kdfBadge.className = 'badge warn';
    kdfBadge.textContent = 'KDF : Repli PBKDF2';
  }

  // AES-GCM
  const data = enc.encode(message);
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);

  const packet = {
    v:1, alg:'AES-GCM', kdf, params:kdfParams,
    salt: toB64(salt), iv: toB64(iv), ct: toB64(ct)
  };
  const json = JSON.stringify(packet);

  cipher.value = json;
  cipherIn.value = json; // pr√™t pour d√©mo d√©chiffrement
  autoCopy(json);
  makeQR(json);
}
encryptBtn.addEventListener('click', encrypt);
clearPlain.addEventListener('click', ()=>{ plain.value=''; });

/* ========= D√©chiffrement ========= */
async function decrypt(){
  const password = pwd.value;
  const json = (cipherIn.value || cipher.value).trim();
  if(!json){ alert('Colle un paquet chiffr√©.'); return; }
  if(!password){ alert('Entre le mot de passe.'); return; }

  let pkt;
  try{ pkt = JSON.parse(json); }catch(e){ alert('Paquet invalide (JSON).'); return; }

  const salt = fromB64(pkt.salt);
  const iv   = fromB64(pkt.iv);
  const ct   = fromB64(pkt.ct).buffer;

  let key;
  try{
    if(pkt.kdf==='argon2id'){
      const res = await deriveKeyArgon(password, salt); key = res.key;
    }else if(pkt.kdf==='pbkdf2-sha256'){
      const res = await deriveKeyPBKDF2(password, salt); key = res.key;
    }else{
      throw new Error('KDF inconnu');
    }
    const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
    plainOut.value = dec.decode(pt);
    decHint.textContent = '';
  }catch(err){
    plainOut.value = '';
    decHint.textContent = '√âchec du d√©chiffrement (mauvais mot de passe ou paquet corrompu).';
  }
}
decryptBtn.addEventListener('click', decrypt);

/* ========= Copier auto & toast ========= */
async function autoCopy(text){
  try{
    await navigator.clipboard.writeText(text);
    toast.textContent = 'Copi√© dans le presse-papiers';
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1400);
  }catch(e){
    // silencieux (iOS peut bloquer hors geste utilisateur)
  }
}
copyBtn.addEventListener('click', ()=>autoCopy(cipher.value||'') );

/* ========= QR code (g√©n√©ration + scan) ========= */
let qr;
function makeQR(str){
  qrcodeBox.innerHTML='';
  qr = new QRCode(qrcodeBox,{
    text: str || ' ',
    width: 220, height: 220,
    colorDark : "#e6f6ff", colorLight : "#0d1423",
    correctLevel : QRCode.CorrectLevel.Q
  });
}
qrBtn.addEventListener('click', ()=> makeQR(cipher.value||'') );
makeQR('');

/* Scanner QR (utilise html5-qrcode) */
let qrScanner;
function startScan(){
  if(qrScanner) return;
  const readerId = "reader";
  if(!document.getElementById(readerId)) return;

  qrScanner = new Html5Qrcode(readerId);
  Html5Qrcode.getCameras().then(cams=>{
    const camId = (cams && cams[0]) ? cams[0].id : null;
    if(!camId) return;
    qrScanner.start(
      camId,
      {fps:10, qrbox: {width: 220, height: 220}},
      (decoded) => {
        cipherIn.value = decoded;
        toast.textContent = 'QR lu';
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 1200);
      },
      (err)=>{}
    );
  });
}
document.addEventListener('visibilitychange',()=>{
  if(document.visibilityState==='visible'){ startScan(); }
});
setTimeout(startScan, 1200); // tente de d√©marrer apr√®s chargement

/* ========= Mode conversation ========= */
convSend.addEventListener('click', async ()=>{
  plain.value = convMe.value;
  await encrypt();
  convOther.value = cipher.value;
});
convRead.addEventListener('click', async ()=>{
  cipherIn.value = convOther.value;
  await decrypt();
  convMe.value = plainOut.value || convMe.value;
});

/* ========= Init force ========= */
renderStrength();
</script>
</body>
</html>
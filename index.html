<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NoteShield ‚Äî Argon2id + AES-GCM (Offline & Direct)</title>

<!-- Librairies -->
<!-- Argon2 (CDN) ‚Äì fallback PBKDF2 si indisponible -->
<script src="https://cdn.jsdelivr.net/npm/argon2-browser@1.13.1/dist/argon2-bundled.min.js"></script>
<!-- QR code -->
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<style>
  :root{
    --bg:#0b1220; --panel:#121a2b; --ink:#cfe7ff; --muted:#8aa2c0;
    --brand1:#62b5ff; --brand2:#8a7dff; --ok:#33d69f; --warn:#ffbf47; --err:#ff6b6b;
    --accent:#1f2740; --glow:0 0 24px rgba(98,181,255,.25);
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:radial-gradient(1200px 800px at 70% -10%,#13223e 0%,#0b1220 55%),var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  h1{font-weight:800;letter-spacing:.5px;text-align:center;margin:28px 12px 4px;
     text-shadow:0 0 24px rgba(138,125,255,.25),0 0 8px rgba(138,125,255,.4)}
  .subtitle{color:var(--muted);text-align:center;margin-bottom:18px}
  .wrap{max-width:980px;margin:0 auto;padding:0 14px 80px}
  .badge{display:inline-block;margin:8px 6px;padding:6px 10px;border:1px solid #2a3550;border-radius:999px;background:linear-gradient(180deg,#172036,#121a2b);color:var(--muted);font-size:.85rem}
  .badge.ok{border-color:#1b4d3a;color:#9ef3ce;background:linear-gradient(180deg,#14382b,#0f2b21)}
  .badge.warn{border-color:#66531f;color:#ffd98a;background:linear-gradient(180deg,#3a2c0f,#2a200c)}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,#151e34,#10182a);border:1px solid #24314d;border-radius:16px;padding:18px;
        box-shadow: var(--glow)}
  .card h2{margin:0 0 10px;font-size:1.15rem}
  label{display:block;color:var(--muted);font-size:.95rem;margin:8px 0 6px}
  textarea,input[type="text"],input[type="password"]{
    width:100%;border:1px solid #2a3550;border-radius:12px;background:#0f1730;color:#e8f3ff;
    padding:14px 14px;font-size:15px;outline:none;transition:.15s border-color,.15s box-shadow
  }
  textarea:focus, input:focus{border-color:#3c83ff;box-shadow:0 0 0 3px rgba(60,131,255,.18)}
  textarea{min-height:130px;resize:vertical}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{
    border:none;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;
    background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#071225;
    box-shadow:0 8px 28px rgba(98,181,255,.2), inset 0 0 0 1px rgba(255,255,255,.08);
    transition:transform .05s ease, filter .15s ease
  }
  .btn:hover{filter:brightness(1.03)}
  .btn:active{transform:translateY(1px)}
  .btn.ghost{background:#172038;color:#bfe1ff;border:1px solid #2a3550}
  .btn.red{background:linear-gradient(135deg,#ff7070,#ff4f86);color:#200a1a}
  .btn.green{background:linear-gradient(135deg,#37e0a0,#47ffa1);color:#003222}
  .muted{color:var(--muted);font-size:.9rem}
  .strength{height:8px;background:#0f1730;border:1px solid #2a3550;border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#ff6b6b,#ffd56b,#92ff9d);transition:width .25s}
  .hint{font-size:.85rem;color:#9ab0cc;margin-top:6px}
  .qr{display:block;margin:10px auto 0;width:180px;height:180px;border-radius:8px;background:#0e162d;border:1px solid #2a3550}
  .logo{display:flex;align-items:center;justify-content:center;gap:10px;margin:12px 0 4px}
  .logo svg{width:34px;height:34px;filter:drop-shadow(0 0 10px rgba(98,181,255,.35))}
  .pill{display:inline-flex;gap:10px;align-items:center;justify-content:center}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
</style>
</head>
<body>
  <div class="wrap">
    <div class="logo">
      <!-- Logo simple ‚ÄúNoteShield‚Äù (SVG inline) -->
      <svg viewBox="0 0 64 64" aria-hidden="true">
        <defs>
          <linearGradient id="g" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#62b5ff"/>
            <stop offset="1" stop-color="#8a7dff"/>
          </linearGradient>
        </defs>
        <path fill="url(#g)" d="M32 4c7 5 16 6 24 6v22c0 9-7 17-24 28C15 49 8 41 8 32V10c8 0 17-1 24-6z"/>
        <path fill="#0b1220" d="M20 45V19h6l10 16V19h8v26h-6L28 29v16z"/>
      </svg>
      <h1>NoteShield</h1>
    </div>
    <div class="subtitle">Chiffrement local <b>AES-GCM</b> avec d√©rivation <b>Argon2id</b> (fallback PBKDF2 si Argon2 indisponible).</div>

    <div class="pill" style="justify-content:center;margin-bottom:12px">
      <span id="netBadge" class="badge">√âtat‚Ä¶</span>
      <span id="kdfBadge" class="badge warn">KDF‚Ä¶</span>
    </div>

    <!-- Mot de passe (commun) -->
    <section class="card">
      <h2>Mot de passe (cl√© secr√®te partag√©e)</h2>
      <div class="row">
        <input id="pwd" type="password" placeholder="Mot de passe robuste (12+ caract√®res)" class="mono" autocomplete="new-password">
        <button id="togglePwd" class="btn ghost" title="Afficher/masquer">üëÅ</button>
        <button id="genPwd" class="btn">G√©n√©rer</button>
      </div>
      <div class="strength" style="margin-top:10px"><div id="bar" class="bar"></div></div>
      <div id="scoreTxt" class="hint">force : 0%</div>
    </section>

    <!-- Mode normal (offline) -->
    <section class="card">
      <h2>Mode normal (offline)</h2>
      <label for="plain">Texte en clair</label>
      <textarea id="plain" placeholder="√âcris ton message ici"></textarea>

      <div class="row" style="margin-top:8px">
        <button id="btnEncrypt" class="btn">Chiffrer</button>
        <button id="btnClear" class="btn ghost">Effacer</button>
      </div>

      <label style="margin-top:14px" for="out">R√©sultat (paquet chiffr√© JSON Base64)</label>
      <textarea id="out" class="mono" placeholder=""></textarea>

      <div class="row" style="margin-top:10px">
        <button id="btnCopy" class="btn ghost">Copier</button>
        <button id="btnQR" class="btn ghost">G√©n√©rer QR</button>
      </div>
      <canvas id="qr" class="qr" hidden></canvas>

      <div class="row" style="margin-top:12px">
        <label class="muted">D√©chiffrer un paquet re√ßu</label>
      </div>
      <textarea id="inCipher" class="mono" placeholder='Colle ici le paquet JSON Base64‚Ä¶'></textarea>
      <div class="row" style="margin-top:10px">
        <button id="btnDecrypt" class="btn green">D√©chiffrer</button>
      </div>
    </section>

    <!-- Mode conversation (offline / copier-coller) -->
    <section class="card">
      <h2>Mode conversation (local/offline)</h2>
      <label for="convMsg">Ton message</label>
      <textarea id="convMsg" placeholder="Bonjour‚Ä¶"></textarea>
      <label for="convIn" style="margin-top:10px">Message chiffr√© re√ßu (colle le JSON ici)</label>
      <textarea id="convIn" class="mono" placeholder=""></textarea>
      <div class="row" style="margin-top:10px">
        <button id="convEncrypt" class="btn">Chiffrer ‚Üí</button>
        <button id="convDecrypt" class="btn ghost">‚Üê D√©chiffrer</button>
      </div>
      <div class="hint">Astuce : apr√®s chiffrement, le paquet est copi√© automatiquement dans le presse-papiers.</div>
    </section>

    <!-- Mode direct (WebRTC) -->
    <section class="card">
      <h2>Mode direct (WebRTC e2e ‚Äî optionnel)</h2>
      <div class="muted" style="margin-bottom:8px">
        √âtablis une session chiffr√©e de pair √† pair. <b>Aucune cl√© n‚Äôest √©chang√©e</b> : utilisez le m√™me mot de passe que ci-dessus.
        Signalisation manuelle via copier/coller (ou QR).
      </div>

      <div class="grid">
        <div>
          <label>1) H√¥te ‚Äî Cr√©er une invitation</label>
          <div class="row">
            <button id="rtcCreate" class="btn">Cr√©er l‚Äôinvitation</button>
            <button id="rtcStopA" class="btn red">Terminer</button>
          </div>
          <textarea id="rtcOffer" class="mono" placeholder="Invitation (code) √† envoyer au correspondant" style="margin-top:8px"></textarea>
          <div class="row" style="margin-top:6px">
            <button id="offerCopy" class="btn ghost">Copier</button>
            <button id="offerQR" class="btn ghost">QR</button>
          </div>
          <canvas id="offerCanvas" class="qr" hidden></canvas>

          <label style="margin-top:10px">3) Coller la r√©ponse distante</label>
          <textarea id="rtcAnswerRemote" class="mono" placeholder="R√©ponse distante‚Ä¶"></textarea>
          <div class="row" style="margin-top:6px">
            <button id="rtcAcceptAnswer" class="btn green">Connecter</button>
          </div>
        </div>

        <div>
          <label>2) Client ‚Äî Accepter une invitation</label>
          <textarea id="rtcOfferRemote" class="mono" placeholder="Colle l‚Äôinvitation re√ßue‚Ä¶"></textarea>
          <div class="row" style="margin-top:6px">
            <button id="rtcAcceptOffer" class="btn">Accepter l‚Äôinvitation</button>
            <button id="rtcStopB" class="btn red">Terminer</button>
          </div>
          <textarea id="rtcAnswer" class="mono" placeholder="R√©ponse (√† renvoyer √† l‚Äôh√¥te)" style="margin-top:8px"></textarea>
          <div class="row" style="margin-top:6px">
            <button id="answerCopy" class="btn ghost">Copier</button>
            <button id="answerQR" class="btn ghost">QR</button>
          </div>
          <canvas id="answerCanvas" class="qr" hidden></canvas>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid #23324f;margin:16px 0">

      <div id="rtcState" class="muted">√âtat : non connect√©</div>

      <div class="row" style="margin-top:10px">
        <textarea id="chatIn" placeholder="Ton message (sera chiffr√© avec le mot de passe)" disabled></textarea>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="chatSend" class="btn" disabled>Envoyer</button>
        <button id="chatClear" class="btn ghost">Nettoyer</button>
      </div>
      <label style="margin-top:10px">Transcription</label>
      <textarea id="chatLog" class="mono" style="min-height:130px" placeholder="" readonly></textarea>
    </section>

  </div>

<script>
/* ---------- helpers UI ---------- */
const $ = sel => document.querySelector(sel);
const netBadge = $("#netBadge");
const kdfBadge = $("#kdfBadge");
function setNetBadge(){ netBadge.textContent = navigator.onLine? "En ligne":"Hors ligne"; netBadge.className = "badge " + (navigator.onLine?"ok":"warn"); }
window.addEventListener('online', setNetBadge);
window.addEventListener('offline', setNetBadge);
setNetBadge();

function setKdfBadge(){
  if (window.argon2) { kdfBadge.textContent = "Argon2id"; kdfBadge.className="badge ok"; }
  else { kdfBadge.textContent = "Repli PBKDF2"; kdfBadge.className="badge warn"; }
}
setKdfBadge();

/* ---------- password + strength ---------- */
const pwd = $("#pwd"), bar=$("#bar"), scoreTxt=$("#scoreTxt");
$("#togglePwd").onclick = ()=> pwd.type = (pwd.type==="password"?"text":"password");
$("#genPwd").onclick = ()=>{
  pwd.value = genPassword();
  updateStrength();
};
pwd.addEventListener('input', updateStrength);
function genPassword(len=20){
  const chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+-=[]{};:,.?/|";
  let s=""; crypto.getRandomValues(new Uint32Array(len)).forEach(n=> s+=chars[n%chars.length]);
  return s;
}
function updateStrength(){
  const s = pwd.value;
  let score=0;
  if(s.length>=8) score+=20;
  if(s.length>=12) score+=20;
  if(/[A-Z]/.test(s)) score+=15;
  if(/[a-z]/.test(s)) score+=15;
  if(/[0-9]/.test(s)) score+=15;
  if(/[^A-Za-z0-9]/.test(s)) score+=15;
  bar.style.width = Math.min(score,100)+"%";
  scoreTxt.textContent = `force : ${Math.min(score,100)}%`;
}

/* ---------- codecs utils ---------- */
const enc = new TextEncoder(), dec = new TextDecoder();
const b64 = arr => btoa(String.fromCharCode(...new Uint8Array(arr)));
const b64toU8 = (s)=> Uint8Array.from(atob(s), c=>c.charCodeAt(0));
function strToB64(str){ return btoa(unescape(encodeURIComponent(str))); }
function b64ToStr(b){ return decodeURIComponent(escape(atob(b))); }

/* ---------- KDF + AES ---------- */
async function deriveKey(password, saltU8, preferArgon=true){
  if (preferArgon && window.argon2){
    // Argon2id
    const params = { pass: password, salt: saltU8, type: argon2.ArgonType.Argon2id, time: 3, mem: 65536, parallelism: 1, hashLen: 32 };
    const { hash } = await argon2.hash(params);
    const key = await crypto.subtle.importKey("raw", hash, "AES-GCM", false, ["encrypt","decrypt"]);
    return { key, meta:{kdf:"argon2id", params:{time:3, mem:65536, par:1}} };
  }else{
    // PBKDF2 fallback
    const baseKey = await crypto.subtle.importKey("raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]);
    const key = await crypto.subtle.deriveKey(
      { name:"PBKDF2", salt: saltU8, iterations:100000, hash:"SHA-256" },
      baseKey,
      { name:"AES-GCM", length:256 },
      false, ["encrypt","decrypt"]
    );
    return { key, meta:{kdf:"pbkdf2-sha256", params:{iter:100000}} };
  }
}
async function encryptJson(plaintext, password){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const {key, meta} = await deriveKey(password, salt, true);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, key, enc.encode(plaintext));
  return {
    v:1, alg:"AES-GCM", kdf:meta.kdf, params:meta.params,
    salt: b64(salt), iv: b64(iv), ct: b64(ct)
  };
}
async function decryptJson(pkt, password){
  try{
    const salt = b64toU8(pkt.salt);
    const {key} = await deriveKey(password, salt, pkt.kdf==="argon2id");
    const iv = b64toU8(pkt.iv);
    const ct = b64toU8(pkt.ct);
    const pt = await crypto.subtle.decrypt({name:"AES-GCM", iv}, key, ct);
    return dec.decode(pt);
  }catch(e){ throw new Error("√âchec du d√©chiffrement ‚Äî mot de passe incorrect ou paquet alt√©r√©."); }
}

/* ---------- Mode normal ---------- */
const plain=$("#plain"), out=$("#out"), inCipher=$("#inCipher");
$("#btnEncrypt").onclick = async ()=>{
  if(!pwd.value) return alert("Merci de saisir un mot de passe.");
  const pkt = await encryptJson(plain.value, pwd.value);
  const txt = strToB64(JSON.stringify(pkt));
  out.value = txt;
  navigator.clipboard?.writeText(txt).catch(()=>{});
};
$("#btnClear").onclick = ()=>{ plain.value=""; out.value=""; inCipher.value=""; $("#qr").hidden=true; };
$("#btnCopy").onclick = ()=> navigator.clipboard?.writeText(out.value);
$("#btnQR").onclick = ()=>{
  const canvas=$("#qr");
  if(!out.value){ canvas.hidden=true; return; }
  const qr = new QRious({element: canvas, value: out.value, size: 180, background:"#0e162d", foreground:"#cfe7ff"});
  canvas.hidden=false;
};
$("#btnDecrypt").onclick = async ()=>{
  if(!pwd.value) return alert("Merci de saisir le mot de passe.");
  try{
    const pkt = JSON.parse(b64ToStr(inCipher.value.trim()));
    const msg = await decryptJson(pkt, pwd.value);
    alert("Message :\n\n"+msg);
  }catch(e){ alert(e.message); }
};

/* ---------- Mode conversation (offline) ---------- */
$("#convEncrypt").onclick = async ()=>{
  if(!pwd.value) return alert("Mot de passe requis.");
  const pkt = await encryptJson($("#convMsg").value, pwd.value);
  const txt = strToB64(JSON.stringify(pkt));
  $("#convIn").value = txt;
  navigator.clipboard?.writeText(txt).catch(()=>{});
};
$("#convDecrypt").onclick = async ()=>{
  try{
    const pkt = JSON.parse(b64ToStr($("#convIn").value.trim()));
    const msg = await decryptJson(pkt, pwd.value);
    $("#convMsg").value = msg;
  }catch(e){ alert(e.message); }
};

/* ---------- WebRTC (mode direct) ---------- */
let pc=null, dc=null, role=null; // "host" or "client"
const iceServers = [{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478?transport=udp"}];
const rtcState = $("#rtcState");
const chatIn=$("#chatIn"), chatSend=$("#chatSend"), chatLog=$("#chatLog");
$("#chatClear").onclick = ()=> chatLog.value="";

function setChatEnabled(on){
  chatIn.disabled = chatSend.disabled = !on;
}

function logChat(who, text){ chatLog.value += `[${who}] ${text}\n`; chatLog.scrollTop = chatLog.scrollHeight; }

async function waitIceGathering(pc){
  if (pc.iceGatheringState === "complete") return;
  await new Promise(resolve=>{
    const check=()=>{ if(pc.iceGatheringState==="complete"){ pc.removeEventListener('icegatheringstatechange',check); resolve(); } };
    pc.addEventListener('icegatheringstatechange', check);
  });
}

function encodeSDP(desc){ return strToB64(JSON.stringify(desc)); }
function decodeSDP(b){ return JSON.parse(b64ToStr(b)); }

function resetRTC(){
  try{ dc && dc.close(); }catch{}
  try{ pc && pc.close(); }catch{}
  pc=dc=null; setChatEnabled(false); rtcState.textContent="√âtat : non connect√©";
}

function installDC(dch){
  dc=dch;
  dc.onopen=()=>{ rtcState.textContent="√âtat : connect√© (canal ouvert)"; setChatEnabled(true); };
  dc.onclose=()=>{ rtcState.textContent="√âtat : ferm√©"; setChatEnabled(false); };
  dc.onmessage= async ev=>{
    try{
      const pkt = JSON.parse(ev.data);
      const msg = await decryptJson(pkt, pwd.value);
      logChat("üîµ Pair", msg);
    }catch(e){
      logChat("‚ö†Ô∏è", "Message non d√©chiffrable");
    }
  };
}

$("#rtcCreate").onclick = async ()=>{
  resetRTC(); role="host";
  pc = new RTCPeerConnection({iceServers});
  const ch = pc.createDataChannel("ns",{ordered:true});
  installDC(ch);
  pc.oniceconnectionstatechange = ()=> rtcState.textContent = "√âtat : "+pc.iceConnectionState;
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await waitIceGathering(pc);
  $("#rtcOffer").value = encodeSDP(pc.localDescription);
};
$("#offerCopy").onclick = ()=> navigator.clipboard?.writeText($("#rtcOffer").value);
$("#offerQR").onclick = ()=>{
  const c=$("#offerCanvas"); const v=$("#rtcOffer").value; if(!v){c.hidden=true;return;}
  new QRious({element:c,value:v,size:180,background:"#0e162d",foreground:"#cfe7ff"}); c.hidden=false;
};
$("#rtcAcceptAnswer").onclick = async ()=>{
  try{
    const desc = decodeSDP($("#rtcAnswerRemote").value.trim());
    await pc.setRemoteDescription(desc);
  }catch(e){ alert("R√©ponse invalide"); }
};
$("#rtcStopA").onclick = resetRTC;

$("#rtcAcceptOffer").onclick = async ()=>{
  resetRTC(); role="client";
  pc = new RTCPeerConnection({iceServers});
  pc.ondatachannel = (ev)=> installDC(ev.channel);
  pc.oniceconnectionstatechange = ()=> rtcState.textContent = "√âtat : "+pc.iceConnectionState;
  try{
    const remote = decodeSDP($("#rtcOfferRemote").value.trim());
    await pc.setRemoteDescription(remote);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await waitIceGathering(pc);
    $("#rtcAnswer").value = encodeSDP(pc.localDescription);
  }catch(e){ alert("Invitation invalide"); }
};
$("#answerCopy").onclick = ()=> navigator.clipboard?.writeText($("#rtcAnswer").value);
$("#answerQR").onclick = ()=>{
  const c=$("#answerCanvas"); const v=$("#rtcAnswer").value; if(!v){c.hidden=true;return;}
  new QRious({element:c,value:v,size:180,background:"#0e162d",foreground:"#cfe7ff"}); c.hidden=false;
};
$("#rtcStopB").onclick = resetRTC;

chatSend.onclick = async ()=>{
  if(!dc || dc.readyState!=="open") return;
  if(!pwd.value) return alert("Mot de passe requis.");
  const msg = chatIn.value.trim();
  if(!msg) return;
  const pkt = await encryptJson(msg, pwd.value);
  dc.send(JSON.stringify(pkt));
  logChat("üü¢ Moi", msg);
  chatIn.value="";
};
</script>
</body>
</html>